.PHONY: help install format format-check lint typecheck check test migrate migrate-auto upgrade downgrade run clean

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
help:
	@echo "Available commands:"
	@echo "  make install        - Install all dependencies"
	@echo "  make format         - Format code with black and ruff"
	@echo "  make format-check   - Check code formatting (CI)"
	@echo "  make lint           - Run linter (ruff)"
	@echo "  make typecheck      - Run type checker (mypy)"
	@echo "  make check          - Run all checks (lint + type check)"
	@echo "  make test           - Run tests with pytest"
	@echo "  make migrate-auto   - Generate migration automatically"
	@echo "  make upgrade        - Apply migrations"
	@echo "  make downgrade      - Rollback last migration"
	@echo "  make run            - Run development server"
	@echo "  make clean          - Clean cache files"

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install:
	pip install -r requirements.txt
	pip install -r requirements-dev.txt

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
format:
	@echo "ðŸŽ¨ Formatting code with black..."
	black app/ alembic/
	@echo "ðŸŽ¨ Sorting imports with ruff..."
	ruff check --select I --fix app/ alembic/
	@echo "âœ… Formatting complete!"

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆCIç”¨ï¼‰
format-check:
	@echo "ðŸŽ¨ Checking code formatting with black..."
	black --check app/ alembic/
	@echo "ðŸŽ¨ Checking import sorting with ruff..."
	ruff check --select I app/ alembic/
	@echo "âœ… Format check complete!"

# ãƒªãƒ³ã‚¿ãƒ¼å®Ÿè¡Œ
lint:
	@echo "ðŸ” Running ruff linter..."
	ruff check app/ alembic/
	@echo "âœ… Linting complete!"

# åž‹ãƒã‚§ãƒƒã‚¯
typecheck:
	@echo "ðŸ” Running mypy type checker..."
	mypy app/
	@echo "âœ… Type check complete!"

# å…¨ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
check: lint typecheck
	@echo "âœ… All checks passed!"

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test:
	@echo "ðŸ§ª Running tests..."
	pytest tests/ -v
	@echo "âœ… Tests complete!"

# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è‡ªå‹•ç”Ÿæˆ
migrate-auto:
	@read -p "Enter migration message: " msg; \
	alembic revision --autogenerate -m "$$msg"

# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
upgrade:
	@echo "â¬†ï¸  Applying migrations..."
	alembic upgrade head
	@echo "âœ… Migrations applied!"

# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
downgrade:
	@echo "â¬‡ï¸  Rolling back migration..."
	alembic downgrade -1
	@echo "âœ… Migration rolled back!"

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
run:
	uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
	@echo "ðŸ§¹ Cleaning cache files..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Cleanup complete!"
